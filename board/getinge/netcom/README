U-Boot environment
==================

Common variables
----------------

This is only needed if the U-Boot binary version from Adeneo is used:

  setenv machid E12

With the U-Boot binary built by Buildroot, the machine number is
already properly set.

For TFTP/NFS booting
--------------------

setenv nfspath NFSPATH
setenv bootargs 'console=ttyS4,115200 root=/dev/nfs nfsroot=SERVERIP:NFSPATH ip=IPADDR mtdparts=atmel_nand:3m(kernel),16m(rootfs)'
setenv bootcmd 'tftp 70000000 uImage; bootm'

For NAND booting
----------------

setenv basebootargs 'console=ttyS4,115200 root=ubi0:rootfs mtdparts=atmel_nand:4m(kernel1),32m(rootfs1),4m(kernel2),32m(rootfs2),4m(conf) rootfstype=ubifs'
setenv kernel_mtdpart 'mtd0'
setenv rootfs_mtdpart 'mtd1'
setenv loadkernel 'if test "${kernel_mtdpart}" = "mtd0" ; then nboot.e 70000000 0 0 ; else nboot.e 70000000 0 2400000 ; fi'
setenv setbootargs 'if test "${rootfs_mtdpart}" = "mtd1" ; then setenv bootargs ubi.mtd=1 ${basebootargs} ; else setenv bootargs ubi.mtd=3 ${basebootargs} ; fi'
setenv bootcmd 'run loadkernel; run setbootargs; bootm'
setenv flashkernel 'nand erase 0 400000; tftp 70000000 uImage; nand write.e 70000000 0 400000; setenv kernel_mtdpart mtd0'
setenv flashrootfs 'nand erase 400000 2400000; tftp 70000000 rootfs.ubi; nand write.e 70000000 400000 ${filesize}; setenv rootfs_mtdpart mtd1'
setenv eraseconfig 'nand erase 0x4800000 0x400000'
setenv flashall 'run flashkernel; run flashrootfs; saveenv'

Reflashing AT91Bootstrap and U-Boot
===================================

Installation
------------

 *) Download and unpack the SAM-BA utility from
    http://www.at91.com/linux4sam/bin/view/Linux4SAM/SoftwareTools

 *) Copy the board/getinge/netcom/isp-extram-at91sam9g45.bin file to
    the tcl_lib/at91sam9g45-ek/ in the SAM-BA installation.

Flashing
--------

 *) Unplug the power from the NetCOM board

 *) Disconnect the Dataflash chipselect jumper

 *) Plug the power and the USB device cable to the NetCOM board

 *) Reconnect the Dataflash chipselect jumper

 *) Create a symbolic link /dev/ttyUSB0 -> /dev/ttyACM0
    sudo ln -s /dev/ttyACM0 /dev/ttyUSB0

    (this is needed because SAM-BA only recognizes ttyUSB* and ttyS*
    while on Linux, the Atmel USB device is recognized as ttyACM*)

 *) Start SAM-BA with the flashing script :

    ./sam-ba /dev/ttyUSB0 at91sam9g45-ekes board/getinge/netcom/samba-script.tcl

Generate a firmware image
=========================

./output/host/usr/bin/fwupgrade-tool -o output/images/fw.img -p kernel:./output/images/uImage -p rootfs:./output/images/rootfs.ubi -i 0x2424

Start the upgrade process from the command line
===============================================

curl -F "file=@./output/images/fw.img" http://IPADDR/cgi-bin/fwupgrade-cgi
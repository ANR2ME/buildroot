From 57d34bb16e1557bcb755a151163b0bf2e1121141 Mon Sep 17 00:00:00 2001
From: Thomas Petazzoni <thomas.petazzoni@free-electrons.com>
Date: Mon, 20 Jun 2011 18:09:10 +0200
Subject: [PATCH] Add serial activity LED trigger driver

Patch taken from
http://www.mail-archive.com/netdev@vger.kernel.org/msg38825.html,
updated to the latest kernel and modified to be used as a serial
activity LED trigger.

Signed-off-by: Thomas Petazzoni <thomas.petazzoni@free-electrons.com>
---
 drivers/leds/Kconfig              |    8 +++
 drivers/leds/Makefile             |    1 +
 drivers/leds/ledtrig-serial.c     |   91 +++++++++++++++++++++++++++++++++++++
 drivers/tty/serial/atmel_serial.c |    2 +-
 include/linux/leds.h              |    7 +++
 include/linux/serial_core.h       |   21 ++++++++-
 6 files changed, 128 insertions(+), 2 deletions(-)
 create mode 100644 drivers/leds/ledtrig-serial.c

diff --git a/drivers/leds/Kconfig b/drivers/leds/Kconfig
index 1fea32f..dac9dbf 100644
--- a/drivers/leds/Kconfig
+++ b/drivers/leds/Kconfig
@@ -417,6 +417,14 @@ config LEDS_TRIGGER_NETWORK_ACT
 	  layer-3 networking.
 	  If unsure, say Y.
 
+config LEDS_TRIGGER_SERIAL_ACT
+	tristate "LED Serial Activity Trigger"
+	depends on LEDS_TRIGGERS
+	depends on SERIAL_CORE
+	help
+	  This allow LEDs to be controlled by serial port activity.
+	  If unsure, say Y.
+
 config LEDS_TRIGGER_HEARTBEAT
 	tristate "LED Heartbeat Trigger"
 	depends on LEDS_TRIGGERS
diff --git a/drivers/leds/Makefile b/drivers/leds/Makefile
index 1bc2c66..b95feca 100644
--- a/drivers/leds/Makefile
+++ b/drivers/leds/Makefile
@@ -50,6 +50,7 @@ obj-$(CONFIG_LEDS_DAC124S085)		+= leds-dac124s085.o
 obj-$(CONFIG_LEDS_TRIGGER_TIMER)	+= ledtrig-timer.o
 obj-$(CONFIG_LEDS_TRIGGER_IDE_DISK)	+= ledtrig-ide-disk.o
 obj-$(CONFIG_LEDS_TRIGGER_NETWORK_ACT)	+= ledtrig-network.o
+obj-$(CONFIG_LEDS_TRIGGER_SERIAL_ACT)	+= ledtrig-serial.o
 obj-$(CONFIG_LEDS_TRIGGER_HEARTBEAT)	+= ledtrig-heartbeat.o
 obj-$(CONFIG_LEDS_TRIGGER_BACKLIGHT)	+= ledtrig-backlight.o
 obj-$(CONFIG_LEDS_TRIGGER_GPIO)		+= ledtrig-gpio.o
diff --git a/drivers/leds/ledtrig-serial.c b/drivers/leds/ledtrig-serial.c
new file mode 100644
index 0000000..b52d240
--- /dev/null
+++ b/drivers/leds/ledtrig-serial.c
@@ -0,0 +1,91 @@
+/*
+ * LED Serial Activity Trigger
+ * based on ledtrig-network by Florian Fainelli
+ * based on ledtrig-ide-disk by Richard Purdie
+ *
+ * Copyright 2007 Florian Fainelli <florian@openwrt.org>
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ *
+ */
+
+#include <linux/module.h>
+#include <linux/jiffies.h>
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/timer.h>
+#include <linux/leds.h>
+
+#define LEDTRIG_SERIAL_ON_DURATION_MSECS 100
+
+static void ledtrig_serial_timerfunc(unsigned long data);
+
+DEFINE_LED_TRIGGER(ledtrig_serial_rx);
+DEFINE_LED_TRIGGER(ledtrig_serial_tx);
+static DEFINE_TIMER(ledtrig_serial_timer, ledtrig_serial_timerfunc, 0, 0);
+static int serial_rx_activity, serial_rx_lastactivity;
+static int serial_tx_activity, serial_tx_lastactivity;
+
+void ledtrig_serial_rx_activity(void)
+{
+	serial_rx_activity++;
+	if (!timer_pending(&ledtrig_serial_timer))
+		mod_timer(&ledtrig_serial_timer, jiffies +
+			  msecs_to_jiffies(LEDTRIG_SERIAL_ON_DURATION_MSECS));
+}
+EXPORT_SYMBOL(ledtrig_serial_rx_activity);
+
+void ledtrig_serial_tx_activity(void)
+{
+	serial_tx_activity++;
+	if (!timer_pending(&ledtrig_serial_timer))
+		mod_timer(&ledtrig_serial_timer, jiffies +
+			  msecs_to_jiffies(LEDTRIG_SERIAL_ON_DURATION_MSECS));
+}
+EXPORT_SYMBOL(ledtrig_serial_tx_activity);
+
+static void ledtrig_serial_timerfunc(unsigned long data)
+{
+	int has_activity = 0;
+
+	if (serial_rx_lastactivity != serial_rx_activity) {
+		serial_rx_lastactivity = serial_rx_activity;
+		led_trigger_event(ledtrig_serial_rx, LED_FULL);
+		has_activity = 1;
+	}
+	else
+		led_trigger_event(ledtrig_serial_rx, LED_OFF);
+
+	if (serial_tx_lastactivity != serial_tx_activity) {
+		serial_tx_lastactivity = serial_tx_activity;
+		led_trigger_event(ledtrig_serial_tx, LED_FULL);
+		has_activity = 1;
+	}
+	else
+		led_trigger_event(ledtrig_serial_tx, LED_OFF);
+
+	if (has_activity)
+		mod_timer(&ledtrig_serial_timer, jiffies + msecs_to_jiffies(LEDTRIG_SERIAL_ON_DURATION_MSECS));
+}
+
+static int __init ledtrig_serial_init(void)
+{
+       led_trigger_register_simple("serial-rx", &ledtrig_serial_rx);
+       led_trigger_register_simple("serial-tx", &ledtrig_serial_tx);
+       return 0;
+}
+
+static void __exit ledtrig_serial_exit(void)
+{
+       led_trigger_unregister_simple(ledtrig_serial_rx);
+       led_trigger_unregister_simple(ledtrig_serial_tx);
+}
+
+module_init(ledtrig_serial_init);
+module_exit(ledtrig_serial_exit);
+
+MODULE_AUTHOR("Florian Fainelli <florian@openwrt.org>");
+MODULE_DESCRIPTION("LED Serial Activity trigger");
+MODULE_LICENSE("GPL");
diff --git a/drivers/tty/serial/atmel_serial.c b/drivers/tty/serial/atmel_serial.c
index f119d17..2c22810 100644
--- a/drivers/tty/serial/atmel_serial.c
+++ b/drivers/tty/serial/atmel_serial.c
@@ -802,7 +802,7 @@ static void atmel_rx_from_dma(struct uart_port *port)
 			 */
 			count = head - tail;
 
-			tty_insert_flip_string(tty, pdc->buf + pdc->ofs, count);
+			uart_insert_string(port, pdc->buf + pdc->ofs, count);
 
 			dma_sync_single_for_device(port->dev, pdc->dma_addr,
 					pdc->dma_size, DMA_FROM_DEVICE);
diff --git a/include/linux/leds.h b/include/linux/leds.h
index 27bee0b..72e1295 100644
--- a/include/linux/leds.h
+++ b/include/linux/leds.h
@@ -171,6 +171,13 @@ extern void ledtrig_network_activity(void);
 #else
 #define ledtrig_network_activity() do {} while(0)
 #endif
+#ifdef CONFIG_LEDS_TRIGGER_SERIAL_ACT
+extern void ledtrig_serial_rx_activity(void);
+extern void ledtrig_serial_tx_activity(void);
+#else
+#define ledtrig_serial_tx_activity() do {} while(0)
+#define ledtrig_serial_rx_activity() do {} while(0)
+#endif
 
 /*
  * Generic LED platform data for describing LED names and default triggers.
diff --git a/include/linux/serial_core.h b/include/linux/serial_core.h
index 758c5b0..1ec53f3 100644
--- a/include/linux/serial_core.h
+++ b/include/linux/serial_core.h
@@ -21,6 +21,7 @@
 #define LINUX_SERIAL_CORE_H
 
 #include <linux/serial.h>
+#include <linux/leds.h>
 
 /*
  * The type definitions.  These are from Ted Ts'o's serial.h
@@ -459,7 +460,16 @@ int uart_match_port(struct uart_port *port1, struct uart_port *port2);
 int uart_suspend_port(struct uart_driver *reg, struct uart_port *port);
 int uart_resume_port(struct uart_driver *reg, struct uart_port *port);
 
-#define uart_circ_empty(circ)		((circ)->head == (circ)->tail)
+static inline int uart_circ_empty(struct circ_buf *circ)
+{
+	if (circ->head == circ->tail)
+		return 1;
+	else {
+		ledtrig_serial_tx_activity();
+		return 0;
+	}
+}
+
 #define uart_circ_clear(circ)		((circ)->head = (circ)->tail = 0)
 
 #define uart_circ_chars_pending(circ)	\
@@ -590,6 +600,8 @@ uart_insert_char(struct uart_port *port, unsigned int status,
 {
 	struct tty_struct *tty = port->state->port.tty;
 
+	ledtrig_serial_rx_activity();
+
 	if ((status & port->ignore_status_mask & ~overrun) == 0)
 		tty_insert_flip_char(tty, ch, flag);
 
@@ -601,6 +613,13 @@ uart_insert_char(struct uart_port *port, unsigned int status,
 		tty_insert_flip_char(tty, 0, TTY_OVERRUN);
 }
 
+static inline int
+uart_insert_string(struct uart_port *port, const unsigned char *chars, size_t size)
+{
+	ledtrig_serial_rx_activity();
+	return tty_insert_flip_string(port->state->port.tty, chars, size);
+}
+
 /*
  *	UART_ENABLE_MS - determine if port should enable modem status irqs
  */
-- 
1.7.4.1

